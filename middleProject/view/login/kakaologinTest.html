<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카카오 간편 로그인</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Tailwind CSS base styles are already included */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        .kakao-login-btn-wrapper {
            margin-bottom: 20px;
        }
        .api-btn {
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .api-btn:hover {
            background-color: #45a049;
        }
        #message-box {
            background-color: #e0f7fa;
            color: #00796b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            word-break: break-all;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #b2ebf2;
        }
        #message-box.error {
            background-color: #ffe0b2;
            color: #e65100;
            border-color: #ffcc80;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">카카오 간편 로그인</h1>

        <!-- Kakao JavaScript SDK Load -->
        <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.5/kakao.min.js" xintegrity="sha384-dok87au0gKqJdxs7msEdBPNnKSRT+/mhTVzq+qOhcL464zXwvcrpjeWvyj1kCdq6" crossorigin="anonymous"></script>

        <script>
            // 카카오 개발자 센터 '내 애플리케이션 > 요약 정보'에서 확인한 JavaScript 키를 입력합니다.
            const KAKAO_JAVASCRIPT_KEY = 'f89ea99cc7619ed687553a8116698691';
            Kakao.init(KAKAO_JAVASCRIPT_KEY);
        </script>

        <div class="kakao-login-btn-wrapper">
            <a id="kakao-login-btn" href="javascript:loginWithKakao()">
                <img src="https://k.kakaocdn.net/14/dn/btroDszwNrM/I6efHub1SN5KCJqLm1Ovx1/o.jpg" width="222" alt="카카오 로그인 버튼" class="rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 mx-auto" />
            </a>
        </div>
        
        <p id="token-result" class="text-gray-600 mb-4">로그인 대기 중...</p>
        <button class="api-btn" onclick="requestUserInfo()" style="visibility:hidden">사용자 정보 가져오기</button>

        <div id="message-box" class="hidden"></div>

        <script>
            // 메시지 박스에 메시지를 표시하는 함수 (alert() 대체)
            function showMessage(message, isError = false) {
                const msgBox = document.getElementById('message-box');
                msgBox.innerText = message;
                msgBox.classList.remove('hidden');
                if (isError) {
                    msgBox.classList.add('error');
                } else {
                    msgBox.classList.remove('error');
                }
            }

            function loginWithKakao() {
                // 현재 웹페이지의 origin (프로토콜 + 호스트명 + 포트)을 가져옵니다.
                const currentOrigin = window.location.origin;
                let redirectUri;

                // 콜백 경로를 정의합니다. 이 경로는 일관되어야 합니다.
                const CALLBACK_PATH = '/kakao-callback'; // 예시: /kakao-callback

                // 현재 환경에 따라 redirectUri를 동적으로 설정합니다.
                // 오류 메시지에 따라 http://127.0.0.1:500을 추가합니다.
                if (currentOrigin === 'http://127.0.0.1:8080') {
                    redirectUri = currentOrigin + CALLBACK_PATH; // 로컬 개발 환경용 (8080 포트)
                } else if (currentOrigin === 'http://127.0.0.1:5500/') { // 추가된 조건
                    redirectUri = currentOrigin + CALLBACK_PATH; // 로컬 개발 환경용 (500 포트)
                } else if (currentOrigin === 'https://hosday.kro.kr/Kakao-CallBack;') {
                    redirectUri = currentOrigin + CALLBACK_PATH; // 운영 환경용
                } else {
                    // 지원되지 않는 환경이거나 기본/오류 처리
                    showMessage('지원되지 않는 Origin: ' + currentOrigin + '. 이 환경에 대한 redirectUri를 구성해주세요.', true);
                    return; // 로그인 프로세스 중단
                }

                // 중요: 이 `redirectUri` (예: http://127.0.0.1:8080/kakao-callback)가
                // 카카오 개발자 센터의 '제품 설정 > 카카오 로그인 > Redirect URI'에
                // 정확히 등록되어 있는지 확인해야 합니다.
                // 로컬 및 운영 URI (각각의 경로 포함) 모두 등록되어 있어야 합니다.
                console.log('카카오 로그인 시도 중, redirectUri:', redirectUri); // 디버깅용

                Kakao.Auth.authorize({
                    redirectUri: redirectUri,
                    state: 'userme', // 선택 사항: CSRF 방지용. 보안 강화를 위해 동적 생성 권장.
                });
            }

            function requestUserInfo() {
                Kakao.API.request({
                    url: '/v2/user/me',
                })
                .then(function(res) {
                    showMessage('사용자 정보 가져오기 성공: \n' + JSON.stringify(res, null, 2));
                })
                .catch(function(err) {
                    showMessage('사용자 정보 가져오기 실패: \n' + JSON.stringify(err, null, 2), true);
                });
            }

            // 이 부분은 `redirectUri`에 지정된 페이지에서 실행되어야 합니다.
            // 단일 HTML 파일 데모를 위해 여기에 포함되었습니다.
            displayToken();

            function displayToken() {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const error = urlParams.get('error');
                const error_description = urlParams.get('error_description');

                if (code) {
                    // 인가 코드를 성공적으로 받았습니다.
                    // Access Token을 얻으려면 이 'code'를 교환해야 합니다.
                    // 이 교환은 보안상의 이유로 일반적으로 서버 측에서 수행됩니다.
                    // 여기서는 코드를 받았음을 나타내고 사용자 정보 버튼을 활성화합니다.
                    document.querySelector('#token-result').innerText = '인가 코드 수신 성공! 사용자 정보 버튼 활성화.';
                    document.querySelector('button.api-btn').style.visibility = 'visible';

                    // SDK에 Access Token이 이미 설정되어 있는지 확인합니다 (예: 이전 성공적인 로그인에서).
                    if (Kakao.Auth.getAccessToken()) {
                        document.querySelector('#token-result').innerText = '로그인 성공, API 요청 준비 완료';
                    } else {
                        // 코드를 받았지만 Access Token이 설정되지 않은 경우 (서버 통합 필요)
                        showMessage('인가 코드를 성공적으로 받았습니다. Access Token 교환에는 서버 통합이 필요할 수 있습니다.', false);
                    }

                } else if (error) {
                    showMessage(`카카오 로그인 실패: ${error} - ${error_description}`, true);
                    document.querySelector('#token-result').innerText = '로그인 실패';
                } else {
                    // 초기 페이지 로드 시 또는 URL에 코드/오류가 없는 경우
                    document.querySelector('#token-result').innerText = '로그인 대기 중...';
                }

                // 이전 쿠키 기반 로직 (현재 흐름에서는 예상대로 작동하지 않을 수 있음)
                var token = getCookie('authorize-access-token');
                if(token) {
                    Kakao.Auth.setAccessToken(token);
                    document.querySelector('#token-result').innerText = '로그인 성공, API 요청 준비 완료';
                    document.querySelector('button.api-btn').style.visibility = 'visible';
                }
            }

            function getCookie(name) {
                var parts = document.cookie.split(name + '=');
                if (parts.length === 2) { return parts[1].split(';')[0]; }
                return null;
            }
        </script>
    </div>
</body>
</html>
