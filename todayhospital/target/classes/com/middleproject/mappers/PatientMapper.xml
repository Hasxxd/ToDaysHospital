<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.middleproject.mappers.PatientMapper">

    <select id="findAllPatients" resultType="com.middleproject.dto.PatientDTO">
        SELECT * FROM PATIENT
    </select>

    <select id="loginCheck"
            parameterType="com.middleproject.dto.LoginDTO"
            resultType="com.middleproject.dto.PatientDTO">
        <![CDATA[
            SELECT
                PATIENT_ID,
                PATIENT_LOGIN_ID,
                PATIENT_NAME,
                PATIENT_EMAIL,
                PATIENT_STATE,
                LOGIN_FAIL_COUNT
            FROM PATIENT
            WHERE PATIENT_LOGIN_ID = #{patientLoginId}
                AND PATIENT_PW = #{patientPw}
                AND NVL(LOGIN_FAIL_COUNT, 0) < 5
                AND PATIENT_STATE = 'Y'
        ]]>
    </select>

    <update id="incrementLoginFailCount" parameterType="java.lang.String">
        UPDATE PATIENT
        SET LOGIN_FAIL_COUNT = NVL(LOGIN_FAIL_COUNT, 0) + 1
        WHERE PATIENT_LOGIN_ID = #{patientLoginId}
    </update>

    <update id="resetLoginFailCount" parameterType="java.lang.String">
        UPDATE PATIENT
        SET LOGIN_FAIL_COUNT = 0
        WHERE PATIENT_LOGIN_ID = #{patientLoginId}
    </update>

    <select id="isAccountLocked" parameterType="java.lang.String" resultType="int">
        SELECT CASE
                    WHEN NVL(LOGIN_FAIL_COUNT, 0) >= 5 THEN 1
                    ELSE 0
                END
        FROM PATIENT
        WHERE PATIENT_LOGIN_ID = #{patientLoginId}
    </select>

    <select id="findByPatientId" parameterType="java.lang.String" resultType="com.middleproject.dto.PatientDTO">
    SELECT
        PATIENT_ID,
        PATIENT_LOGIN_ID,
        PATIENT_NAME,
        PATIENT_EMAIL,
        PATIENT_STATE
    FROM PATIENT
    WHERE PATIENT_LOGIN_ID = #{patientLoginId}
    </select>
<!--
    <select id="findByLoginId" parameterType="java.lang.String" resultType="com.middleproject.dto.PatientDTO">
        SELECT
            PATIENT_ID,
            PATIENT_LOGIN_ID,
            PATIENT_NAME,
            PATIENT_EMAIL,
            PATIENT_STATE
        FROM PATIENT
        WHERE PATIENT_LOGIN_ID = #{patientLoginId}
    </select>

    <update id="updateLogoutLog" parameterType="map">
        UPDATE SYSTEM_LOG
        SET LOG_DATE = SYSDATE,
            LOG_STATUS = 'LOGOUT',
            LOG_INFO = '사용자 로그아웃 처리'
        WHERE PATIENT_LOGIN_ID = #{patientLoginId}
            AND LOG_STATUS = 'LOGIN'
            AND LOG_DATE = (
                SELECT MAX(LOG_DATE)
                FROM SYSTEM_LOG
                WHERE PATIENT_LOGIN_ID = #{patientLoginId}
                    AND LOG_STATUS = 'LOGIN'
            )
    </update> -->

</mapper>
